/**
 *
 * November 2013
 */

var comment = {
	height : '100',
	content : '',
	elm_target : 'box_comment',
	data : '',
	com_url : 'https://comment.detik.com/',
	isMobile : 0,
	create : function(data) {
		if(typeof(data.target) != 'undefined')
			comment.elm_target = data.target;

		// var ctop = $('#'+comment.elm_target).position().top;
		var ctop = '';
		var cur_com = '';
		var hashes = location.hash.split('#')[1];
		if(typeof(hashes) != 'undefined') {
			if(hashes.substring(0, 9) == 'commentid')
				cur_com = hashes.substring(9);
		}
		var view = 0;
		if(typeof(data.view) != 'undefined')
			view = data.view;

		var limit = 10;
		if(typeof(data.limit) != 'undefined')
			limit = data.limit;
		if(parseInt(limit) > 20)
			limit = 20;

		var prefix = '';
		if(typeof(data.prefix) != 'undefined')
			prefix = data.prefix;


		var callBack = '';
		if(typeof(data.callBack) != 'undefined')
			callBack = data.callBack;

		var url_share = '';
		if(typeof(data.url_share) != 'undefined')
			url_share = data.url_share;

		var appId = '';
		if(typeof(data.appId) != 'undefined')
			appId = data.appId;

		var clientId = '';
		if(typeof(data.clientId) != 'undefined')
			clientId = data.clientId;

		var css = '';
		if(typeof(data.css) != 'undefined')
			css = data.css;

		var complete = '';
		if(typeof(data.complete) != 'undefined')
			complete = data.complete;

		if(typeof(data.isMobile) != 'undefined')
			this.isMobile = data.isMobile;

		var prokontra = 0;
		if(typeof(data.prokontra) != 'undefined')
			var prokontra = data.prokontra;

		var headtohead = 0;
		if(typeof(data.headtohead) != 'undefined') {
			if(parseInt(data.headtohead) == 1) {
				var prokontra = 2;
			}
		}

		var label1 = '';
		var label2 = '';
		if(typeof(data.label1) != 'undefined' && typeof(data.label2) != 'undefined') {
				var label1 = data.label1;
				var label2 = data.label2;
		}

		var nativeAdskanal = '';
		if (appId != '') {
			adsKanal = comment.getNativeAdslabel(appId);
			// adsKanal.label = 'kanal_devel';
			nativeAdskanal = '?native='+adsKanal.label+'&env='+adsKanal.env;
			console.log(adsKanal.label);

		}

		var parent_url = document.URL;
		var param = '#identifier='+data.identifier+'||group='+data.group+'||date='+data.date+'||ctop='+ctop;
		param += '||commentid='+cur_com+'||limit='+limit+'||view='+view+'||callback='+callBack+'||url_share='+url_share;
		param += '||complete='+complete+'||prefix='+prefix;
		param += '||appId='+appId;
		param += '||clientId='+clientId+'||prokontra='+prokontra+'||isMobile='+this.isMobile+'||css='+css+'||title='+encodeURIComponent(data.title)+'||parent_url='+encodeURIComponent(parent_url)+'||label1='+label1+'||label2='+label2;
		var elm_frame = $('<iframe/>').attr({allowtransparency:'true', frameborder:'0', role:'complementary', width : '100%', id:'forframe',
			scrolling:'no', horizontalscrolling:'no', verticalscrolling:'no', src:comment.com_url+'v2/api/datalayer/index.php'+nativeAdskanal+param})
			.attr({'style': 'width: 100% !important; border: none !important; overflow: hidden !important'})
			.css({width : '100% !important', border:'none !important', overflow:'hidden !important', height: comment.height+'px !important'});

		$('#'+comment.elm_target).html(elm_frame);
	},
	shoutout : function(data) {
		if(typeof(data.target) != 'undefined')
			comment.elm_target = data.target;

		var ctop = $('#'+comment.elm_target).position().top;
		var cur_com = '';
		var hashes = location.hash.split('#')[1];
		if(typeof(hashes) != 'undefined') {
			if(hashes.substring(0, 9) == 'commentid')
				cur_com = hashes.substring(9);
		}
		var view = 0;
		if(typeof(data.view) != 'undefined')
			view = data.view;

		var limit = 10;
		if(typeof(data.limit) != 'undefined')
			limit = data.limit;
		if(parseInt(limit) > 20)
			limit = 20;

		var prefix = '';
		if(typeof(data.prefix) != 'undefined')
			prefix = data.prefix;

		var callBack = '';
		if(typeof(data.callBack) != 'undefined')
			callBack = data.callBack;

		var url_share = '';
		if(typeof(data.url_share) != 'undefined')
			url_share = data.url_share;

		var appId = '';
		if(typeof(data.appId) != 'undefined')
			appId = data.appId;

		var clientId = '';
		if(typeof(data.clientId) != 'undefined')
			clientId = data.clientId;

		var css = '';
		if(typeof(data.css) != 'undefined')
			css = data.css;

		var complete = '';
		if(typeof(data.complete) != 'undefined')
			complete = data.complete;

		var parent_url = document.URL;
		var param = '#identifier='+data.identifier+'||group='+data.group+'||date='+data.date+'||ctop='+ctop;
		param += '||commentid='+cur_com+'||limit='+limit+'||view='+view+'||callback='+callBack+'||url_share='+url_share;
		param += '||complete='+complete+'||prefix='+prefix;
		param += '||appId='+appId;
		param += '||clientId='+clientId+'||css='+css+'||title='+data.title+'||parent_url='+parent_url;
		var elm_frame = $('<iframe/>').attr({allowtransparency:'true', frameborder:'0', role:'complementary', width : '100%', id:'forframe',
			scrolling:'no', horizontalscrolling:'no', verticalscrolling:'no', src:comment.com_url+'v2/api/datalayer/index.php'+param})
			.attr({'style': 'width: 100% !important; border: none !important; overflow: hidden !important'})
			.css({width : '100% !important', border:'none !important', overflow:'hidden !important', height: comment.height+'px !important'});

		$('#'+comment.elm_target).html(elm_frame);
	},
	resize  : function (val) {
		$('#forframe').attr({'style':'width: 100% !important; border: none !important; overflow: hidden !important; height:'+val+'px !important;'});
		$('#forframe').css({height:val+'px'});
		$('#'+comment.elm_target).attr({'style':'overflow:hidden !important'});
	},
	layout : function() {
		if (comment.isMobile > 0) {
			$('.to_login_m').find('a')[0].click();
		}
		else {
			if ($('.user_login').html() == 'undefined' || $('.user_login').html() == null) {
				if ($('.to_login').hasClass('log')) {
					window.location.href = $('.to_login').attr('href');
				}
				else {
					var triggered = 0;
					$('.to_login').each(function(index, value) {

						if (!$(this).hasClass('notrigger') && triggered ==0) {
							triggered = 1;
							$(this).trigger('click');
							return
						}
					});
				}

				$('.calldc').trigger('click');
			}
			else {
				if (typeof($('#kanal_detik').html()) != 'undefined') {
					$('.logreg')[0].click();
					return;
				}
				$('.user_login').find('a')[0].click();
			}
		}

	},
	shareIt : function (commentid) {
		var com_id	= commentid.substring(7);
		var urlpage	= document.URL+'#'+commentid;
		var shorturl = 'http://comment.detik.com/v2/?callback=short&com_id='+com_id+'&detikurl='+urlpage;
		//alert(shorturl);
		$.ajax({
			url			: shorturl,
			type		: "GET",
			dataType	:'jsonp',
			beforeSend	: function() {

			},
			success	: function(data){
				var shorturl = '';
				if(typeof(data.short) != 'undefined') {
					shorturl = data.short;

					comment.shareElement(shorturl, com_id);
				}
			},
			error	: function (e) {

			}
		});
	},
	shareElement : function (shorturl, com_id) {
		var bx_content		= $('<div/>').addClass('share_komentar');

		var data	= comment.data;
		var parent_url = document.URL;
		var param = '#identifier='+data.identifier+'|group='+data.group+'|date='+data.date+'|title='+data.title
					+'|com_id='+com_id+'|shorturl='+shorturl+'|parent_url='+parent_url;

		var elm_frame = $('<iframe/>').attr({allowtransparency:'true', frameborder:'0', role:'complementary', width : '100%', id:'forframe',
			scrolling:'no', horizontalscrolling:'no', verticalscrolling:'no', src:'http://comment.detik.com/v2/ShareIframe'+param})
			.attr({'style': 'width: 400px !important; height : 240px; border: none !important; overflow: hidden !important'});

		$(bx_content).append(elm_frame);

		comment.popup(bx_content);
	},
	popup : function (data) {
		var bg_page_login	= $('<div/>').attr({id: 'bg_page_login', style: 'display: block'});
		var box_login		= $('<div/>').addClass('box_login');
		var black_close		= $('<div/>').attr({id: 'black_close'});

		var content			= data;

		$(box_login).append(content);
		$(bg_page_login).append(box_login).append(black_close);

		$('body').append(bg_page_login);
	},
	popup_close : function () {
		$('#bg_page_login').hide(300);
		setTimeout(function(){
			$('#bg_page_login').remove();
		}, 300);
	},
	position : function (data) {
		var top	= data.substring(7);

		$(window).scrollTop(top);
	},
	callback : function (data) {
		var params	= data.split('||');
		var fnstring = params[0];
		var attr	= params[1];
		var attr2	= '';
		var attr3	= '';

		if(typeof(params[2]))
			attr2	= params[2];

		if(typeof(params[3]))
			attr3	= params[3];

		var fnparams = [attr, attr2, attr3];

		var fn = window[fnstring];

		if (typeof fn === "function") fn.apply(null, fnparams);
	},
	getNativeAdslabel : function(appId) {
		var label = '';
		var env = '';
		if (appId == 3){ 
		// detikNews desktop
			label = 'detik_news';
			env = 'desktop';	
		}

		if (appId == 93){
		// detikNews msite
			label = 'detik_news';
			env = 'mobile';	
		}
		if (appId == 27){
		// sepakBola desktop
			label = 'detik_sepakbola';
			env = 'desktop';	
		}	
		if (appId == 95){
		// sepakBola msite

			label = 'detik_sepakbola';
			env = 'mobile';	
		} 
		if (appId == 29){
		// finance desktop
			label = 'detik_finance';
			env = 'desktop';	
		} 	
		if (appId == 96){
		// finance msite
			label = 'detik_finance';
			env = 'mobile';	
		} 	
		if (appId == 21){ 
		// sport desktop
			label = 'detik_sport';
			env = 'desktop';	
			}
		if (appId == 94){ 
		// sport msite
			label = 'detik_sport';
			env = 'mobile';	
			}
		if (appId == 32){ 
		// hot desktop
			label = 'detik_hot';
			env = 'desktop';	
			}
		if (appId == 97){ 
		// hot msite
			label = 'detik_hot';
			env = 'mobile';	
			}
		if (appId == 44){ 
		// oto desktop
			label = 'detik_oto';
			env = 'desktop';	
			}
		if (appId == 99){ 
		// oto msite
			label = 'detik_oto';
			env = 'mobile';	
			}
		if (appId == 5){ 
		// inet desktop
			label = 'detik_inet';
			env = 'desktop';	
			}
		if (appId == 98){ 
		// inet msite
			label = 'detik_inet';
			env = 'mobile';	
			}
		if (appId == 35){ 
		// food desktop
			label = 'detik_food';
			env = 'desktop';	
			}
		if (appId == 100){ 
		// food msite
			label = 'detik_food';
			env = 'mobile';	
			}
		if (appId == 55){ 
		// health desktop
			label = 'detik_health';
			env = 'desktop';	
			}
		if (appId == 101){ 
		// health msite
			label = 'detik_health';
			env = 'mobile';	
			}
		if (appId == 66){ 
		// travel desktop
			label = 'detik_travel';
			env = 'desktop';	
			}
		if (appId == 106){ 
		// travel msite
			label = 'detik_travel';
			env = 'mobile';	
			}
		if (appId == 63){ 
		// wolipop desktop
			label = 'wolipop';
			env = 'desktop';	
			}
		if (appId == 107){ 
		// wolipop msite
			label = 'wolipop';
			env = 'mobile';	
			}

		var result = {'label': label, 'env': env}

		return result
	}
}

$(document).ready(function(){
	if ($.fn.receiveMessage) {
		$.receiveMessage(
			function(e){
				var data = e.data;
				//console.log('receive data : ' + data);
				//alert('receive data : ' + data);

				if(data.substring(0,6) == 'height') {
					//console.log('height : ' + data);
					var height = data.split(':')[1];
					comment.resize(height);
				}
				else if(data.substring(0,7) == 'comment') {
					comment.shareIt(data);
				}
				else if (data.substring(0, 10) == 'closeframe')
					comment.popup_close();
				else if (data.substring(0, 7) == 'com_top')
					comment.position(data);
				else if(data.substring(0,5) == 'login') {
					comment.layout();
				}
				else if(data.substring(0,8) == 'callback') {
					var fnstring = data.substring(9);
					comment.callback(fnstring);
				}
			},
			'https://comment.detik.com'
		);
	}
	else {
		function receiveMessage(event){
			//console.log(event);
			if (event.origin == 'https://comment.detik.com') {
				//console.log(event.data);
				var data = event.data;

				if(data.substring(0,6) == 'height') {
					//console.log('height : ' + data);
					var height = data.split(':')[1];
					comment.resize(height);
				}
				else if(data.substring(0,7) == 'comment') {
					comment.shareIt(data);
				}
				else if (data.substring(0, 10) == 'closeframe')
					comment.popup_close();
				else if (data.substring(0, 7) == 'com_top')
					comment.position(data);
				else if(data.substring(0,5) == 'login') {
					comment.layout();
				}
				else if(data.substring(0,8) == 'callback') {
					var fnstring = data.substring(9);
					comment.callback(fnstring);
				}
			}
		}

		window.addEventListener("message", receiveMessage, false);

	}
});
